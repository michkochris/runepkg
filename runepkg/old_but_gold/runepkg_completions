#!/bin/bash

# Bash completion for runepkg
# This script provides autocompletion for runepkg commands and package names

_runepkg_completions() {
    local cur=${COMP_WORDS[COMP_CWORD]}
    local prev=${COMP_WORDS[COMP_CWORD-1]}
    local words=("${COMP_WORDS[@]}")
    local cword=$COMP_CWORD

    # Load package list from runepkg_dir
    local pkglist=()
    local txt_file=$(runepkg --print-pkglist-file 2>/dev/null | awk '/Text file:/ {print $3}')
    if [[ -f "$txt_file" ]]; then
        mapfile -t pkglist < "$txt_file"
    fi

    # Enable case-insensitive matching
    shopt -s nocaseglob

    # Find the last command flag
    local last_cmd=""
    for ((i=1; i<cword; i++)); do
        case "${words[i]}" in
            -i|--install|-r|--remove|-s|--status|-S|--search|-L|--list-files|-l|--list)
                last_cmd="${words[i]}"
                ;;
        esac
    done

    # Debug output (comment out for production)
    # echo "DEBUG: cur='$cur', last_cmd='$last_cmd', pkglist=(${pkglist[*]})" >&2

    case "$last_cmd" in
        -i|--install)
            if [[ "$cur" == */* ]]; then
                # Complete files in the specified directory
                local dir="${cur%/*}"
                local prefix="${cur%/*}/"
                local base="${cur##*/}"
                if [[ -d "$dir" ]]; then
                    COMPREPLY=($(compgen -f -- "$dir/$base" | sed "s|^$dir/|$prefix|"))
                fi
            else
                # Complete local files and directories
                COMPREPLY=($(compgen -f -- "$cur"))
            fi
            ;;
        -S|--search)
            # Complete with file paths
            COMPREPLY=($(compgen -f -- "$cur"))
            ;;
        -r|--remove|-s|--status|-L|--list-files|-l|--list)
            # Complete with package names from pkglist
            local matches=($(compgen -W "${pkglist[*]}" -- "$cur"))
            if [[ ${#matches[@]} -eq 1 ]]; then
                COMPREPLY=("${matches[0]}")
            elif [[ ${#matches[@]} -gt 1 ]]; then
                # Complete to the first match to allow full completion
                COMPREPLY=("${matches[0]}")
            fi
            ;;
        *)
            # Complete with options and package names
            local options="-i --install -r --remove -l --list -s --status -L --list-files -S --search -v --verbose -f --force --version -h --help --print-config --print-config-file --print-pkglist-file"
            if [[ $cur == -* ]]; then
                COMPREPLY=($(compgen -W "$options" -- "$cur"))
            else
                COMPREPLY=($(compgen -W "$options ${pkglist[*]}" -- "$cur"))
            fi
            ;;
    esac

    # Custom completion options
    compopt -o nospace    # Don't add space after completion
}

complete -F _runepkg_completions runepkg